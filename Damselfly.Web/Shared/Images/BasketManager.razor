
@using Damselfly.Core.ImageProcessing
@implements IDisposable

@inject ImageService imageService
@inject ThumbnailService thumbService
@inject BasketService basketService
@inject NavigationManager NavigationManager
@inject WordpressService wpService
@inject UserService userService   

<div class="InputAddOn">
    <div class="InputAddOn-item" title="Saved Baskets"><i class="fas fa-shopping-basket" /></div>
    @if (!AddingBasket)
    {
        <select @onchange="BasketSelectionChanged" class="InputAddOn-field">
            @foreach (var basket in baskets)
            {
            <option value="@basket.Name">@basket.Name @PrivateIndicator(basket)</option>
            }
        </select>
        <button title="Add Basket" @onclick="@(() => AddBasket())" class="InputAddOn-item"><i class="fa fa-plus-circle" /></button>
    }
    else
    {
        <input placeholder="Basket Name" class="InputAddOn-field" @bind-value="NewBasketName" @bind-value:event="oninput" />
        <button class="InputAddOn-item" title="Save Basket" @onclick="@(() => SaveBasket())"><i class="fa fa-save" /></button>
        <button class="InputAddOn-item" title="Cancel Adding" @onclick="@(() => CancelAdding())"><i class="fa fa-times-circle" /></button>
    }
</div>

@code {
    readonly List<Basket> baskets = new List<Basket>();
    bool AddingBasket { get; set; }
    string NewBasketName { get; set; }

    private string PrivateIndicator(Basket basket)
    {
        if (basket?.UserId == null)
            return "(public)";

        return string.Empty;
    }

    private void SaveBasket()
    {
        AddingBasket = false;
        var newName = NewBasketName;
        NewBasketName = string.Empty;

        basketService.CreateNewBasket(newName, userService.User);
        basketService.SwitchBasket(newName);

        StateHasChanged();
    }

    private void CancelAdding()
    {
        AddingBasket = false;
        StateHasChanged();
    }

    private void AddBasket()
    {
        AddingBasket = true;
        StateHasChanged();
    }

    private void BasketSelectionChanged(ChangeEventArgs e)
    {
        basketService.SwitchBasket(e.Value.ToString());
    }


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            basketService.OnBasketChanged += BasketsChanged;

            await LoadBasketList();
        }
    }

    public void Dispose()
    {
        basketService.OnBasketChanged -= BasketsChanged;
    }

    private void BasketsChanged()
    {
        _ = LoadBasketList();
    }

    public async Task LoadBasketList()
    {
        var watch = new Stopwatch("LoadBaskets");

        var myBaskets = await basketService.GetUserBaskets( userService.User );

        this.baskets.Clear();
        this.baskets.AddRange( myBaskets );
        watch.Stop();

        await InvokeAsync(StateHasChanged);
    }
}

