@using Damselfly.Core.DbModels
@using Microsoft.AspNetCore.Identity
@using Damselfly.Core.Utils.Constants

@inject UserConfigService configService
@inject IJSRuntime JsRuntime

@code{
    [Parameter]
    [EditorRequired]
    public string ScrollElementId { get; set; }

    [Parameter]
    [EditorRequired]
    public string ScrollConfigName { get; set; }

    private EventConflator conflator = new EventConflator(1000);

    private void SaveScrollState(int scrollTop)
    {
        configService.Set(ScrollConfigName, scrollTop.ToString());
    }

    public async Task InitScrollPosition()
    {
        int scrollPos = configService.GetInt(ScrollConfigName, 0);

        Logging.Log("Data loaded - initialising scroll position");
        await JsRuntime.InvokeVoidAsync("ScrollMonitor.Init", ScrollElementId, DotNetObjectReference.Create(this), scrollPos);
    }

    [JSInvokable]
    // Debugging method to help us differentiate between JS calls and other data loads
    public void HandleScroll(int scrollTop)
    {
        conflator.HandleEvent((x) => { SaveScrollState(scrollTop); });
    }
}
