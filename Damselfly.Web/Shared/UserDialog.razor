@using Damselfly.Core.DbModels

@inject UserService userService

<MudDialog>
    <DialogContent>
        <MudTextField @bind-Value="@User.UserName" Label="User Name" ReadOnly="false" Variant="Variant.Filled" />
        <MudTextField @bind-Value="@User.Email" InputType="InputType.Email" Label="Email" ReadOnly="false" Variant="Variant.Filled" />
        <MudTextField @bind-Value="@password" InputType="InputType.Password" Label="Password" ReadOnly="false" Variant="Variant.Filled" autocomplete="off" />
        <MudTextField @bind-Value="@passwordConfirm" InputType="InputType.Password" Label="Confirm Password" ReadOnly="false" Variant="Variant.Filled" autocomplete="off"/>
        @if (allRoles != null)
        {
            <MudSelect T="string" Label="User Roles" HelperText="Select the roles to which this user belongs" @bind-Value="selectedRole" Variant="Variant.Filled">
                @foreach (var role in allRoles)
                {
                    <MudSelectItem T="string" Value="@role.Name">@role.Name</MudSelectItem>
                }
            </MudSelect>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="Save">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
        [CascadingParameter]
        MudDialogInstance MudDialog { get; set; }

        [Parameter]
        public AppIdentityUser User { get; set; } = new AppIdentityUser();

    private string password, passwordConfirm, selectedRole;

    private ICollection<ApplicationRole> allRoles;

    // TODO: Get better return values here and show errors if there are any.
    async Task Save()
    {
        bool success = true;

        if (!string.IsNullOrEmpty(password) && !password.StartsWith( "*****" ) && password.Equals(passwordConfirm))
        {
            success = await userService.SetUserPasswordAsync(User, password);
        }

        if( success )
        {
            success = await userService.UpdateUserAsync(User, selectedRole);
        }

        if( success )
            MudDialog.Close(DialogResult.Ok(true));
    }

    void Cancel() => MudDialog.Cancel();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            allRoles = await userService.GetRoles();
            if (User.UserRoles.Any())
            {
                var role = User.UserRoles.First();
                selectedRole = role.Role.Name;
                StateHasChanged();
            }
        }
    }
}